let gallery=document.querySelector(".gallery"),modalGallery=document.querySelector(".modal__gallery"),modal=document.querySelector("#modal"),addProjectModal=document.querySelector("#modal--add"),overlay=document.querySelector(".overlay"),photoContainer=document.querySelector(".add-photo__container"),submitAddBtn=document.querySelector("#submit-btn"),works=JSON.parse(localStorage.getItem("works"));async function fetchWorks(){try{let e=await (await fetch("http://localhost:5678/api/works")).json();e=JSON.stringify(e),localStorage.setItem("works",e)}catch(t){console.error(t)}}function displayWorks(e){for(let t=0;t<e.length;t++){let l=document.createElement("a");l.href=e[t].imageUrl,gallery.appendChild(l);let o=document.createElement("figure");l.appendChild(o);let r=document.createElement("img");r.src=e[t].imageUrl,r.alt=e[t].title,o.appendChild(r);let a=document.createElement("figcaption");a.innerText=e[t].title,o.appendChild(a)}}async function fetchCategories(){try{let e=await (await fetch("http://localhost:5678/api/categories")).json();e=JSON.stringify(e),localStorage.setItem("categories",e)}catch(t){console.error(t)}}null!==works||fetchWorks(),displayWorks(works),fetchCategories();let allProjectsBtn=document.querySelector(".all-btn");allProjectsBtn.addEventListener("click",()=>{updateGallery(works,allProjectsBtn)});let categories=JSON.parse(localStorage.getItem("categories"));for(let i=0;i<categories.length;i++){sortWorks(document.querySelector(".objects-btn"),categories[0].id);sortWorks(document.querySelector(".apartments-btn"),categories[1].id);sortWorks(document.querySelector(".hotels-btn"),categories[2].id)}function updateGallery(e,t){gallery.innerHTML="",displayWorks(e),document.querySelectorAll(".filters-btn").forEach(e=>{e.classList.remove("active")}),t.classList.add("active")}function sortWorks(e,t){e.addEventListener("click",()=>{updateGallery(works.filter(e=>e.categoryId==t),e)})}let connexionParams=new URLSearchParams(document.location.search),connexionStatus=connexionParams.get("connected");if("1"===connexionStatus){displayHiddenEls(),deleteAllProjects();let e=new FormData;document.querySelector("#project-photo").addEventListener("change",()=>{let t=document.querySelector("#project-photo").files[0];checkUploadFile(t,e),displayUploadFile(t)}),checkInputValue(),sendForm(e)}function displayHiddenEls(){for(let e=0;e<categories.length;e++){let t=document.createElement("option");t.value=categories[e].id,t.text=categories[e].name,document.querySelector("#category").add(t)}let l=document.querySelector(".edit-bar");document.querySelector("header").style.marginTop="55px",l.classList.remove("hidden"),l.addEventListener("click",()=>{updateGallery(works,allProjectsBtn)}),document.querySelector(".log").textContent="logout",document.querySelectorAll(".update-btn").forEach(e=>{e.classList.remove("hidden"),e.addEventListener("click",()=>{openGalleryModal(modal,overlay);let e=document.querySelectorAll(".grow-up");for(let t=0;t<e.length;t++)e[0].focus()})})}function openGalleryModal(e,t){openModal(e,t),displayModalGallery(),document.querySelector("#add").addEventListener("click",()=>{e.classList.add("hidden"),openAddModal(e,t)})}function openAddModal(e,t){openModal(addProjectModal,t);document.querySelector(".js-prev-arrow").addEventListener("click",()=>{addProjectModal.classList.add("hidden"),openGalleryModal(e,t)})}function openModal(e,t){e.classList.remove("hidden"),t.classList.contains("hidden")&&t.classList.remove("hidden"),document.querySelector("body").style.overflow="hidden",closeModal(e,t)}function closeModal(e,t){document.querySelectorAll(".js-close-modal").forEach(l=>{l.addEventListener("click",()=>{hideModal(e,t)})}),t.addEventListener("click",()=>{hideModal(e,t)})}function hideModal(e,t){e.classList.add("hidden"),t.classList.add("hidden"),document.querySelector("body").style.overflow="visible",history.pushState("",document.title,window.location.pathname+window.location.search)}function displayModalGallery(){modalGallery.innerHTML="";for(let e=0;e<works.length;e++){let t=document.createElement("figure");t.setAttribute("data-id",works[e].id),modalGallery.appendChild(t);let l=document.createElement("img");l.src=works[e].imageUrl,l.alt=works[e].title,t.appendChild(l);let o=document.createElement("figcaption");t.appendChild(o);let r=document.createElement("span");r.classList.add("modal__icons"),o.appendChild(r);let a=document.createElement("a");a.href=works[e].imageUrl,a.className="grow-up",r.appendChild(a);let d=document.createElement("i");d.classList.add("fa-solid","fa-arrows-up-down-left-right"),a.appendChild(d);let n=document.createElement("i");n.classList.add("fa-regular","fa-trash-can","delete-icon"),n.setAttribute("tabindex","0"),r.appendChild(n);let s=document.createElement("button");s.textContent="\xe9diter",s.className="update-project",o.appendChild(s)}deleteProject()}function deleteProject(){let e=document.querySelectorAll(".delete-icon");for(let t=0;t<e.length;t++)e[t].addEventListener("click",()=>{deleteToAPI(Number(e[t].closest("[data-id]").dataset.id))})}async function deleteToAPI(e){try{(await fetch(`http://localhost:5678/api/works/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}})).ok&&(deleteToLocalStorage(e),works=JSON.parse(localStorage.getItem("works")),displayModalGallery())}catch(t){console.error(t)}}function deleteToLocalStorage(e){works=works.filter(t=>t.id!==e),localStorage.setItem("works",JSON.stringify(works))}function deleteAllProjects(){modalGallery.innerHTML="";document.querySelector("#delete-all").addEventListener("click",()=>{for(let e=0;e<works.length;e++)deleteToAPI(Number(works[e].id))})}function checkUploadFile(e,t){if(e.size>"4194304"){let l=document.createElement("p");l.textContent="L'image s\xe9lectionn\xe9e est trop lourde",l.classList.add("alert","add-error"),photoContainer.appendChild(l)}else document.querySelector(".add-error")&&document.querySelector(".add-error").classList.add("hidden"),t.set("image",document.querySelector("#project-photo").files[0])}function displayUploadFile(e){let t=new FileReader;t.addEventListener("load",e=>{let t=document.createElement("img");t.src=e.target.result,t.id="upload",document.querySelector(".add-photo__content").classList.add("hidden"),photoContainer.style.padding="0",photoContainer.appendChild(t)}),t.readAsDataURL(e),convertFileNameToTitle(e.name)}function convertFileNameToTitle(e){e=e.replace(/\.jpg$|\.png$|-|_/g," ");document.querySelector("#title").value=e}function checkInputValue(){document.querySelector("#category").addEventListener("change",e=>{null!==document.querySelector("#title").value&&null!==e.target.value&&""!==document.querySelector("#project-photo").value&&(submitAddBtn.removeAttribute("disabled"),submitAddBtn.classList.remove("inactive-btn"))})}function sendForm(e){document.querySelector("#add-form").addEventListener("submit",t=>{t.preventDefault(),AddProjectToApi(e)})}async function AddProjectToApi(e){e.set("title",document.querySelector("#title").value),e.set("category",document.querySelector("#category").value);try{let t=await fetch("http://localhost:5678/api/works",{method:"POST",headers:{accept:"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:e});if(t.ok){let l=await t.json();for(let o of(works.push(l),localStorage.setItem("works",works),fetchWorks(),hideModal(addProjectModal,overlay),updateGallery(works,allProjectsBtn),submitAddBtn.classList.add("inactive-btn"),submitAddBtn.setAttribute("disabled","disabled"),document.querySelector("#add-form").reset(),document.querySelector(".add-photo__content").classList.remove("hidden"),document.querySelector("#upload").remove(),e.keys()))e.delete(o);e.delete("title")}}catch(r){console.error(r)}};